[![Sous](https://circleci.com/gh/fourkitchens/sous-drupal-project.svg?style=svg)](https://app.circleci.com/github/fourkitchens/sous-drupal-project/pipelines)
[![semantic-release: angular](https://img.shields.io/badge/semantic--release-angular-e10079?logo=semantic-release)](https://github.com/semantic-release/semantic-release)
<br/>
<img style="max-width: 400px;" src="https://github.com/fourkitchens/sous-drupal-distro/blob/4.x-beta/themes/sous_admin/assets/images/sous.svg" alt="Sous featuring Emulsify">

# Sous Project

A starter kit for your Drupal project that simplifies your project setup with [Emulsify](https://www.emulsify.info/). This starter kit includes a small set
of contrib modules, a bundle of basic configuration, and a starter theme generated by [EmulsifyCLI](https://docs.emulsify.info/supporting-projects/emulsify-cli).

## Features and Configurations

Sous not only generates a custom theme based on Emulsify, it also builds upon Drupal's default configuration to help streamline the project setup process. See the feature set documentation [here](docs/features.md).

# Installation

## Requirements

Without these you will have difficulty installing this project.

1. [PHP ^8.1](http://www.php.net/)
2. [Composer 2.x](https://getcomposer.org/)
3. [Lando ^3.6](https://docs.lando.dev/basics/installation.html)

Use this command below and replace `PROJECT_NAME` with your chosen project name.

```
composer create-project fourkitchens/sous-drupal-project [PROJECT-NAME] --no-interaction
```

## Tweak project

- Modify .gitignore
  - Remove the commented block at the EOF
  - Review ignored items you may need for your build and remove them

## Optional Demo content and theme

Sous can optionally install some demo content and a fully styled and wired theme. Note: This should only be ran immediately after installation. It contains basic content type and media architecture changes and may affect custom configuration unexpectedly.

`lando sous-demo-install`

# Working with Emulsify

The [Emulsify](https://emulsify.info/) theme is installed as part of this project.

# Additional Tooling

This package provides some additional tooling to support the build.


## Helper scripts

To use the helper script provided you will need to have `npm` installed. Then just run `npm run <command>`. For example: `npm run import-data`. These commands are bash scripts located in the `./scripts/sous` directory and defined in `package.json`.

## Configuration management scripts

**confex**

```
npm run confex
```

Export active configuration to the config directory.

**confim**

```
npm run confim
```

Import the configuration to the database.

**import-data**

```
npm run import-data
```

Import a copy of the canonical database backup into your local instance. This assumes the database backup is located in `./reference/db.sql.gz`.

**local-data-bak**

```
npm run local-data-bak
```

Create a local database backup. Saves the backup to the `./reference` directory.

**rebuild**

```
npm run rebuild
```

Rebuild a fresh local instance of your site. Imports the canonical database backup and imports configuration into it.

**setup**

```
npm run setup
```

This is run during the installation process of composer create project.

**theme-build**

```
npm run theme-build
```

Builds the emulsify based theme.

**theme-watch**

```
npm run theme-watch
```

Used for theme development.

# Semantic Versioning

## Setup

1. This repo has the following named/maintenance branches:

```
main
x.x
x.x.x
```

2. These branches are protected on GitHub
3. A personal access token was created for CircleCI.
4. CircleCI was setup to run on this project and tag the releases
5. Commit changes following the [Conventional commit guidelines](https://www.conventionalcommits.org/en/v1.0.0/)
6. Push your change up and verify CircleCI passes and has run on your desired branch.

## Troubleshooting

1. Your branch must be a named stable release branch in order to get a tag.
2. Prereleases are not supported with this package because they contain a dot.

# Contributing

The composer command can be adjusted to account for a new branch you're working on.

```
composer create-project fourkitchens/sous-drupal-project:dev-[branch-name] PROJECT_NAME --no-interaction
```

## Contribute without create-project

## Recipe update

There is a base recipe included and scaffolded called sous_base that includes a basic set of modules for administration and security.

To run setup + install:
1. clone repo `gh repo clone fourkitchens/sous-drupal-project [directory]`
2. `cd` to your project directory
3. change the name of your project in .lando.yml
4. `lando start`
5. `lando composer install`
6. `composer run-script post-create-project-cmd` (Requires composer to be installed locally. i.e. outside lando)

For the paragraphs version of Sous, run:

`lando install-recipe fourkitchens/sous_paragraphs`

### Composer update
1. Removed the normal Sous Drupal dependencies
2. Upgraded to Drupal 10
3. Added patch that allows recipes to be applied
4. Added post update script to scaffold recipes from assets to web/recipes (scripts/recipe-scaffold.sh)

### Assets
1. Added sous_base recipe

### Scripts
1. Added script that installs a recipe using lando (scripts/install-recipe.sh)
2. Modified setup.sh script to install the Minimal profile without existing config (we will use recipes to install config) and install sous_base recipe
3. Modified sous/Starter.php script to rewrite the theme name in the recipe to match the installed theme

### Lando
1. Added command that installs a recipe using a script (see above)
